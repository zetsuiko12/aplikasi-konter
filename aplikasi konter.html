<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAOMI CELL v11.0 - Pro Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #1e293b; }
        .nav-btn { transition: all 0.3s; position: relative; opacity: 0.5; }
        .nav-btn.active { color: #3b82f6; opacity: 1; }
        .nav-btn.active::after { content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); width: 20px; height: 4px; background: #3b82f6; border-radius: 10px; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; font-size: 10px; cursor: pointer; border: 1px solid #f1f5f9; background: white; }
        .day-cell:hover { background: #eff6ff; border-color: #3b82f6; }
        .day-has-data { background: #e0f2fe; border-color: #7dd3fc; font-weight: bold; }
        @media print { .no-print { display: none !important; } #printSection { display: block !important; } }
        #printSection { display: none; }
    </style>
</head>
<body class="bg-[#f8fafc]">

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-3xl shadow-2xl flex gap-8 z-50 no-print">
        <button onclick="showPage('service')" id="btn-service" class="nav-btn active flex flex-col items-center gap-1">
            <i class="fa-solid fa-screwdriver-wrench text-xl"></i><span class="text-[10px] font-bold uppercase">Service</span>
        </button>
        <button onclick="showPage('finance')" id="btn-finance" class="nav-btn flex flex-col items-center gap-1">
            <i class="fa-solid fa-chart-line text-xl"></i><span class="text-[10px] font-bold uppercase">Laporan</span>
        </button>
        <button onclick="showPage('transaksi')" id="btn-transaksi" class="nav-btn flex flex-col items-center gap-1">
            <i class="fa-solid fa-bolt text-xl"></i><span class="text-[10px] font-bold uppercase">PPOB</span>
        </button>
        <button onclick="showPage('second')" id="btn-second" class="nav-btn flex flex-col items-center gap-1">
            <i class="fa-solid fa-mobile-screen-button text-xl"></i><span class="text-[10px] font-bold uppercase">HP Second</span>
        </button>
    </nav>

    <div class="max-w-7xl mx-auto p-4 md:p-8 pb-32">
        <header class="flex justify-between items-center mb-10 no-print">
            <div>
                <h1 class="text-3xl font-black italic tracking-tighter text-slate-800">NAOMI<span class="text-blue-600">CELL</span></h1>
                <p id="clockDisplay" class="text-xs font-mono text-slate-400 font-bold uppercase tracking-widest"></p>
            </div>
            <div class="flex gap-2">
                <label class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold cursor-pointer hover:bg-blue-700 shadow-lg shadow-blue-200 transition">
                    <i class="fa-solid fa-file-import mr-2"></i> IMPORT DATA LAMA
                    <input type="file" id="importFile" class="hidden" onchange="handleImport(event)">
                </label>
            </div>
        </header>

        <section id="page-service" class="page-content space-y-6">
            <div class="glass-card p-6 rounded-[2rem] shadow-sm no-print">
                <h2 class="text-lg font-black mb-4 flex items-center gap-2"><i class="fa-solid fa-circle-plus text-blue-500"></i> INPUT SERVICE BARU</h2>
                <form id="serviceForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="hidden" id="editSvcId">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 ml-1 uppercase">Nama & WhatsApp</label>
                        <input type="text" id="svcCust" placeholder="Nama Pelanggan" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm" required>
                        <input type="tel" id="svcWa" placeholder="08xxxxxxxx" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 ml-1 uppercase">Unit & Kerusakan</label>
                        <input type="text" id="svcUnit" placeholder="Tipe HP" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold uppercase" required>
                        <input type="text" id="svcCond" placeholder="Analisa Kerusakan" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 ml-1 uppercase">Tanggal</label>
                        <input type="date" id="svcDateIn" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold">
                        <input type="date" id="svcDateOut" class="w-full p-3 bg-emerald-50 border border-emerald-100 rounded-xl text-sm font-bold" title="Tanggal Selesai">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 ml-1 uppercase">Opsi & Garansi</label>
                        <select id="svcType" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold">
                            <option value="Ditinggal">DITINGGAL</option>
                            <option value="Ditunggu">DITUNGGU</option>
                        </select>
                        <input type="text" id="svcGaransi" placeholder="Garansi (Contoh: 7 Hari)" class="w-full p-3 bg-blue-50 border border-blue-100 rounded-xl text-sm font-bold text-blue-600">
                    </div>

                    <div class="md:col-span-4 space-y-2">
                        <div class="flex justify-between items-center px-1">
                            <span class="text-[10px] font-black text-slate-400 uppercase">Detail Biaya (Sparepart / Jasa)</span>
                            <button type="button" onclick="addSvcPart()" class="text-[10px] font-black text-blue-600 hover:underline">+ TAMBAH ITEM</button>
                        </div>
                        <div id="svcPartsList" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
                    </div>

                    <div class="md:col-span-4 flex flex-wrap gap-4 items-center justify-between bg-slate-900 p-6 rounded-3xl text-white mt-2">
                        <div class="flex gap-4">
                            <div>
                                <label class="block text-[9px] opacity-50 font-bold mb-1 uppercase">Metode</label>
                                <select id="svcPayMethod" onchange="toggleDpInput()" class="bg-white/10 p-2.5 rounded-xl text-xs font-bold border border-white/20 outline-none">
                                    <option value="Bayar Saat Ambil">BAYAR SAAT AMBIL</option>
                                    <option value="DP">DP (PANJAR)</option>
                                    <option value="Cash">LUNAS (CASH)</option>
                                </select>
                            </div>
                            <div id="dpBox" class="hidden">
                                <label class="block text-[9px] opacity-50 font-bold mb-1 uppercase">Nominal DP</label>
                                <input type="text" id="svcDpVal" value="0" onkeyup="formatPrice(this); calcSvcTotal()" class="bg-white/10 p-2.5 rounded-xl text-xs font-bold border border-orange-500/50 w-28 text-orange-400">
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] opacity-50 font-bold uppercase tracking-widest">Estimasi Total</p>
                            <h3 id="svcTotalDisp" class="text-4xl font-black font-mono">Rp 0</h3>
                        </div>
                    </div>

                    <div class="md:col-span-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button type="submit" id="svcSubmitBtn" class="bg-blue-600 text-white font-black py-4 rounded-2xl text-xs uppercase tracking-widest hover:bg-blue-700 transition shadow-xl shadow-blue-100">Simpan Data Service</button>
                        <button type="button" onclick="resetSvcForm()" class="bg-slate-200 text-slate-600 font-black py-4 rounded-2xl text-xs uppercase tracking-widest hover:bg-slate-300">Reset Form</button>
                    </div>
                </form>
            </div>

            <div class="glass-card rounded-[2rem] overflow-hidden shadow-sm no-print">
                <div class="p-6 border-b border-slate-100 flex flex-wrap justify-between items-center gap-4 bg-white/50">
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                            <input type="text" id="searchSvc" onkeyup="renderSvcTable()" placeholder="Cari Pelanggan / Unit / WA..." class="pl-10 pr-4 py-2.5 bg-slate-100 border-none rounded-xl text-xs w-64 focus:ring-2 ring-blue-500 font-semibold">
                        </div>
                        <input type="date" id="filterSvcDate" onchange="renderSvcTable()" class="py-2.5 px-4 bg-slate-100 border-none rounded-xl text-xs font-bold">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="sortSvc('newest')" class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase hover:bg-slate-50 transition">Terbaru</button>
                        <button onclick="sortSvc('oldest')" class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase hover:bg-slate-50 transition">Terlama</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 text-[9px] font-black uppercase text-slate-400 tracking-widest border-b">
                            <tr>
                                <th class="p-5">Masuk</th>
                                <th class="p-5">Pelanggan</th>
                                <th class="p-5">Unit / Kerusakan</th>
                                <th class="p-5 text-right">Tagihan</th>
                                <th class="p-5 text-center">Status Kerja</th>
                                <th class="p-5 text-center">Pengambilan</th>
                                <th class="p-5 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="svcListTable" class="text-[11px] font-semibold divide-y divide-slate-50 bg-white"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="page-finance" class="page-content hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-blue-600 p-6 rounded-[2rem] text-white shadow-xl shadow-blue-100">
                    <p class="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">Pemasukan Hari Ini</p>
                    <h2 id="sumDayIn" class="text-2xl font-black font-mono">Rp 0</h2>
                </div>
                <div class="bg-slate-900 p-6 rounded-[2rem] text-white shadow-xl">
                    <p class="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">Laba Bulan Ini</p>
                    <h2 id="sumMonthNet" class="text-2xl font-black font-mono">Rp 0</h2>
                </div>
                <div class="bg-white p-6 rounded-[2rem] border border-slate-200">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Belanja Hari Ini</p>
                    <h2 id="sumDayOut" class="text-2xl font-black font-mono text-red-500">Rp 0</h2>
                </div>
                <div class="bg-white p-6 rounded-[2rem] border border-slate-200">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Belanja Bulan Ini</p>
                    <h2 id="sumMonthOut" class="text-2xl font-black font-mono text-orange-500">Rp 0</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-card p-6 rounded-[2rem] shadow-sm">
                        <h3 class="font-black text-slate-800 uppercase italic mb-4 flex items-center gap-2"><i class="fa-solid fa-chart-area text-blue-500"></i> Statistik 7 Hari</h3>
                        <canvas id="financeChart" height="110"></canvas>
                    </div>
                    <div class="glass-card p-6 rounded-[2rem] shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-black text-slate-800 uppercase italic">Kalender Keuangan</h3>
                            <div class="flex gap-2 items-center">
                                <button onclick="changeMonth(-1)" class="p-2 bg-slate-100 rounded-lg hover:bg-slate-200"><i class="fa-solid fa-chevron-left"></i></button>
                                <span id="calMonthLabel" class="text-xs font-black uppercase tracking-widest min-w-[120px] text-center">Januari 2026</span>
                                <button onclick="changeMonth(1)" class="p-2 bg-slate-100 rounded-lg hover:bg-slate-200"><i class="fa-solid fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <div id="calendarGrid" class="calendar-grid"></div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-slate-900 rounded-[2rem] p-6 text-white shadow-xl min-h-[400px]">
                        <h3 class="font-black uppercase text-[10px] text-blue-400 mb-6 flex justify-between border-b border-white/10 pb-4">
                            RINCIAN BELANJA <span id="spendingDateLabel" class="text-white">-</span>
                        </h3>
                        <div id="spendingList" class="space-y-3 mb-6"></div>
                        <button onclick="addSpendingRow()" class="w-full py-4 border border-dashed border-white/20 rounded-2xl text-[10px] font-black uppercase hover:bg-white/5 transition">+ Input Belanja Alat</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-transaksi" class="page-content hidden space-y-6">
            <div class="glass-card p-8 rounded-[3rem] shadow-sm max-w-2xl mx-auto">
                <h2 class="text-2xl font-black mb-8 text-center uppercase tracking-tighter">TRANSAKSI PULSA & PPOB</h2>
                <form id="ppobForm" class="space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Kategori</label>
                            <select id="ppobJenis" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold outline-none focus:ring-2 ring-blue-500">
                                <option value="Isi Pulsa">ISI PULSA / DATA</option>
                                <option value="Token Listrik">TOKEN LISTRIK</option>
                                <option value="Transfer Uang">TRANSFER UANG</option>
                                <option value="Tarik Tunai">TARIK TUNAI</option>
                                <option value="Top Up E-Wallet">TOP UP E-WALLET</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Nomor / ID</label>
                            <input type="text" id="ppobTarget" placeholder="08... / ID Pelanggan" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold outline-none focus:ring-2 ring-blue-500" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Harga Beli</label>
                            <input type="text" id="ppobModal" placeholder="0" onkeyup="formatPrice(this)" class="w-full p-4 bg-red-50 border border-red-100 rounded-2xl font-bold text-red-600">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Harga Jual</label>
                            <input type="text" id="ppobJual" placeholder="0" onkeyup="formatPrice(this)" class="w-full p-4 bg-emerald-50 border border-emerald-100 rounded-2xl font-bold text-emerald-600">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Admin Konter</label>
                            <input type="text" id="ppobAdmin" value="0" onkeyup="formatPrice(this)" class="w-full p-4 bg-blue-50 border border-blue-100 rounded-2xl font-bold text-blue-600">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-slate-900 text-white font-black py-5 rounded-3xl uppercase tracking-widest text-sm hover:scale-[1.02] transition shadow-xl">SIMPAN TRANSAKSI</button>
                </form>
            </div>
        </section>

        <section id="page-second" class="page-content hidden space-y-6">
            <div class="glass-card p-6 rounded-[2rem] shadow-sm mb-6">
                <h2 class="text-lg font-black mb-4 flex items-center gap-2"><i class="fa-solid fa-tags text-orange-500"></i> MANAJEMEN STOK SECOND</h2>
                <form id="secondForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-2 space-y-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Tipe Unit & Kondisi</label>
                        <input type="text" id="secUnit" placeholder="Contoh: iPhone 12 128GB iBox" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold uppercase" required>
                        <textarea id="secNote" placeholder="Keterangan minus atau kelengkapan..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs" rows="2"></textarea>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Modal Masuk</label>
                        <input type="text" id="secBeli" placeholder="Harga Beli" onkeyup="formatPrice(this)" class="w-full p-3 bg-red-50 border border-red-100 rounded-xl font-bold text-red-600" required>
                        <input type="text" id="secPart" placeholder="Biaya Repair" onkeyup="formatPrice(this)" class="w-full p-3 bg-orange-50 border border-orange-100 rounded-xl font-bold text-orange-500">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Harga Jual</label>
                        <input type="text" id="secHarga" placeholder="Buka Harga" onkeyup="formatPrice(this)" class="w-full p-3 bg-blue-50 border border-blue-100 rounded-xl font-bold text-blue-600">
                        <input type="text" id="secTerjual" placeholder="Harga Deal" onkeyup="formatPrice(this)" class="w-full p-3 bg-emerald-50 border border-emerald-100 rounded-xl font-bold text-emerald-600" title="Isi jika sudah laku">
                    </div>
                    <div class="md:col-span-4 flex justify-end gap-2">
                        <button type="submit" class="bg-blue-600 text-white font-black px-10 py-3 rounded-xl text-xs uppercase shadow-lg shadow-blue-100">Tambah ke Stok</button>
                    </div>
                </form>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="secondList"></div>
        </section>
    </div>

    <div id="printSection" class="p-4 text-slate-900 font-mono text-[10px] leading-tight">
        <center>
            <h2 class="text-lg font-black italic">NAOMI CELL</h2>
            <p>Spesialis Service & PPOB</p>
            <p id="printTgl"></p>
            <p>--------------------------------</p>
        </center>
        <div id="printContent" class="space-y-1 mt-4"></div>
        <div class="mt-6 text-center">
            <p>--------------------------------</p>
            <p id="printFooterNote">Simpan nota ini untuk klaim garansi.</p>
            <p class="mt-2 opacity-50">v11.0 Digital System</p>
        </div>
    </div>

    <script>
        // --- CORE DATABASE ---
        let dbSvc = JSON.parse(localStorage.getItem('NAOMI_V11_SVC')) || [];
        let dbFinance = JSON.parse(localStorage.getItem('NAOMI_V11_FIN')) || {};
        let dbPPOB = JSON.parse(localStorage.getItem('NAOMI_V11_PPOB')) || [];
        let dbSecond = JSON.parse(localStorage.getItem('NAOMI_V11_SEC')) || [];
        
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let chartInstance = null;

        const $ = id => document.getElementById(id);
        const fmt = n => "Rp " + (parseInt(n) || 0).toLocaleString('id-ID');
        const num = s => parseInt(s.toString().replace(/\D/g, "")) || 0;
        const today = () => new Date().toISOString().split('T')[0];

        function saveAll() {
            localStorage.setItem('NAOMI_V11_SVC', JSON.stringify(dbSvc));
            localStorage.setItem('NAOMI_V11_FIN', JSON.stringify(dbFinance));
            localStorage.setItem('NAOMI_V11_PPOB', JSON.stringify(dbPPOB));
            localStorage.setItem('NAOMI_V11_SEC', JSON.stringify(dbSecond));
        }

        function showPage(p) {
            document.querySelectorAll('.page-content').forEach(pg => pg.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(bn => bn.classList.remove('active'));
            $(`page-${p}`).classList.remove('hidden');
            $(`btn-${p}`).classList.add('active');
            if(p === 'service') renderSvcTable();
            if(p === 'finance') { renderFinance(); initChart(); }
            if(p === 'second') renderSecondHand();
        }

        // --- SERVICE LOGIC ---
        function addSvcPart(n = '', p = '') {
            const id = 'pt-' + Math.random().toString(36).substr(2, 5);
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex gap-2 items-center bg-white p-2 rounded-xl border border-slate-100 shadow-sm";
            div.innerHTML = `
                <input type="text" placeholder="Jasa / Part" value="${n}" class="pn text-[11px] font-bold flex-1 border-none bg-transparent outline-none">
                <input type="text" placeholder="Harga" value="${p ? p.toLocaleString('id-ID') : ''}" onkeyup="formatPrice(this); calcSvcTotal()" class="pr text-[11px] font-black text-blue-600 w-24 text-right border-none bg-transparent outline-none">
                <button type="button" onclick="$('${id}').remove(); calcSvcTotal()" class="text-red-300 hover:text-red-500 transition"><i class="fa-solid fa-circle-xmark"></i></button>
            `;
            $('svcPartsList').appendChild(div);
        }

        function toggleDpInput() {
            $('dpBox').classList.toggle('hidden', $('svcPayMethod').value !== 'DP');
        }

        function calcSvcTotal() {
            let total = 0;
            document.querySelectorAll('.pr').forEach(el => total += num(el.value));
            $('svcTotalDisp').innerText = fmt(total);
            return total;
        }

        $('serviceForm').onsubmit = e => {
            e.preventDefault();
            const parts = [];
            document.querySelectorAll('#svcPartsList > div').forEach(d => {
                const n = d.querySelector('.pn').value;
                if(n) parts.push({n, p: num(d.querySelector('.pr').value)});
            });

            const editId = $('editSvcId').value;
            const data = {
                id: editId || 'SVC-' + Date.now().toString().slice(-6),
                cust: $('svcCust').value,
                wa: $('svcWa').value,
                unit: $('svcUnit').value,
                cond: $('svcCond').value,
                tIn: $('svcDateIn').value || today(),
                tOut: $('svcDateOut').value,
                type: $('svcType').value,
                garansi: $('svcGaransi').value || '-',
                parts,
                total: calcSvcTotal(),
                dp: num($('svcDpVal').value),
                payMethod: $('svcPayMethod').value,
                statusWork: 'Belum Selesai',
                statusTake: 'Belum Diambil'
            };

            if(editId) {
                const idx = dbSvc.findIndex(x => x.id === editId);
                data.statusWork = dbSvc[idx].statusWork;
                data.statusTake = dbSvc[idx].statusTake;
                dbSvc[idx] = data;
            } else {
                dbSvc.unshift(data);
            }
            
            saveAll(); resetSvcForm(); renderSvcTable();
            alert('Data Service Tersimpan!');
        };

        function resetSvcForm() {
            $('serviceForm').reset();
            $('editSvcId').value = '';
            $('svcPartsList').innerHTML = '';
            $('svcTotalDisp').innerText = 'Rp 0';
            $('svcDateIn').value = today();
            $('svcSubmitBtn').innerText = "Simpan Data Service";
            addSvcPart();
        }

        function renderSvcTable() {
            const query = $('searchSvc').value.toLowerCase();
            const dateF = $('filterSvcDate').value;
            const list = $('svcListTable');
            list.innerHTML = '';

            dbSvc.filter(s => {
                const matchSearch = s.cust.toLowerCase().includes(query) || s.unit.toLowerCase().includes(query) || s.wa.includes(query);
                const matchDate = dateF ? s.tIn === dateF : true;
                return matchSearch && matchDate;
            }).forEach(s => {
                const row = document.createElement('tr');
                row.className = "hover:bg-blue-50/40 transition";
                row.innerHTML = `
                    <td class="p-5 font-mono text-slate-400">${s.tIn}</td>
                    <td class="p-5">
                        <div class="font-bold text-slate-800">${s.cust}</div>
                        <div class="text-[10px] text-green-500">${s.wa}</div>
                    </td>
                    <td class="p-5">
                        <div class="font-black uppercase text-blue-600">${s.unit}</div>
                        <div class="text-[10px] opacity-60">${s.cond}</div>
                    </td>
                    <td class="p-5 text-right font-black">
                        ${fmt(s.total)}
                        <div class="text-[9px] text-orange-500">DP: ${fmt(s.dp)}</div>
                    </td>
                    <td class="p-5 text-center">
                        <button onclick="toggleSvcStatus('${s.id}', 'work')" class="px-3 py-1 rounded-full text-[9px] font-black uppercase ${s.statusWork === 'Selesai' ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-400'}">${s.statusWork}</button>
                    </td>
                    <td class="p-5 text-center">
                        <button onclick="toggleSvcStatus('${s.id}', 'take')" class="px-3 py-1 rounded-full text-[9px] font-black uppercase ${s.statusTake === 'Sudah Diambil' ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'}">${s.statusTake}</button>
                    </td>
                    <td class="p-5">
                        <div class="flex gap-3 justify-center">
                            <button onclick="sendWa('${s.id}')" class="text-green-500 hover:scale-125 transition"><i class="fa-brands fa-whatsapp text-lg"></i></button>
                            <button onclick="printNota('${s.id}')" class="text-slate-400 hover:text-slate-900"><i class="fa-solid fa-print"></i></button>
                            <button onclick="editSvc('${s.id}')" class="text-blue-400 hover:text-blue-600"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="delSvc('${s.id}')" class="text-red-200 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </td>
                `;
                list.appendChild(row);
            });
        }

        function toggleSvcStatus(id, type) {
            const idx = dbSvc.findIndex(x => x.id === id);
            if(type === 'work') dbSvc[idx].statusWork = dbSvc[idx].statusWork === 'Selesai' ? 'Belum Selesai' : 'Selesai';
            if(type === 'take') {
                dbSvc[idx].statusTake = dbSvc[idx].statusTake === 'Sudah Diambil' ? 'Belum Diambil' : 'Sudah Diambil';
                if(dbSvc[idx].statusTake === 'Sudah Diambil') dbSvc[idx].tOut = today();
            }
            saveAll(); renderSvcTable();
        }

        function editSvc(id) {
            const s = dbSvc.find(x => x.id === id);
            $('editSvcId').value = s.id;
            $('svcCust').value = s.cust;
            $('svcWa').value = s.wa;
            $('svcUnit').value = s.unit;
            $('svcCond').value = s.cond;
            $('svcDateIn').value = s.tIn;
            $('svcDateOut').value = s.tOut || '';
            $('svcType').value = s.type;
            $('svcGaransi').value = s.garansi;
            $('svcPayMethod').value = s.payMethod;
            $('svcDpVal').value = s.dp.toLocaleString('id-ID');
            toggleDpInput();
            
            $('svcPartsList').innerHTML = '';
            s.parts.forEach(p => addSvcPart(p.n, p.p));
            calcSvcTotal();
            $('svcSubmitBtn').innerText = "Update Data " + s.id;
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function delSvc(id) {
            if(confirm('Hapus data service?')) {
                dbSvc = dbSvc.filter(x => x.id !== id);
                saveAll(); renderSvcTable();
            }
        }

        function sendWa(id) {
            const s = dbSvc.find(x => x.id === id);
            let phone = s.wa.replace(/\D/g, '');
            if(phone.startsWith('0')) phone = '62' + phone.slice(1);
            const msg = `*NAOMI CELL - UPDATE SERVICE*%0A%0AUnit: *${s.unit.toUpperCase()}*%0AStatus: *${s.statusWork.toUpperCase()}*%0ATotal Tagihan: *${fmt(s.total)}*%0ADP: ${fmt(s.dp)}%0A*Sisa: ${fmt(s.total - s.dp)}*%0A%0AUnit bisa diambil di konter. Terima kasih.`;
            window.open(`https://api.whatsapp.com/send?phone=${phone}&text=${msg}`);
        }

        function printNota(id) {
            const s = dbSvc.find(x => x.id === id);
            $('printTgl').innerText = 'Tgl: ' + s.tIn;
            $('printContent').innerHTML = `
                <b>ID: ${s.id}</b><br>
                Pelanggan: ${s.cust}<br>
                Unit: ${s.unit}<br>
                Kerusakan: ${s.cond}<br>
                -------------------------<br>
                ${s.parts.map(p => `+ ${p.n}: ${fmt(p.p)}`).join('<br>')}<br>
                -------------------------<br>
                TOTAL: ${fmt(s.total)}<br>
                DP: ${fmt(s.dp)}<br>
                <b>SISA: ${fmt(s.total - s.dp)}</b><br>
                Garansi: ${s.garansi}
            `;
            $('printFooterNote').innerText = s.statusTake === 'Sudah Diambil' ? "BARANG SUDAH DIAMBIL" : "TANDA TERIMA BARANG";
            window.print();
        }

        // --- FINANCE LOGIC ---
        function renderFinance() {
            const months = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
            $('calMonthLabel').innerText = `${months[currentMonth]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            let html = '';
            for(let i=0; i<firstDay; i++) html += '<div></div>';
            
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasAct = dbSvc.some(s => s.tIn === dateStr) || (dbFinance[dateStr] && dbFinance[dateStr].length > 0);
                html += `<div onclick="selectFinDate('${dateStr}')" class="day-cell ${dateStr === today() ? 'border-blue-500 border-2' : ''} ${hasAct ? 'day-has-data' : ''}">${d}</div>`;
            }
            $('calendarGrid').innerHTML = html;
            updateSummaries();
        }

        function selectFinDate(date) {
            $('spendingDateLabel').innerText = date;
            const spendList = $('spendingList');
            spendList.innerHTML = '';
            if(dbFinance[date]) {
                dbFinance[date].forEach((it, idx) => {
                    spendList.innerHTML += `
                        <div class="flex justify-between items-center text-[11px] bg-white/5 p-3 rounded-xl border border-white/5">
                            <span>${it.n}</span>
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-orange-400">${fmt(it.p)}</span>
                                <button onclick="delSpending('${date}', ${idx})" class="text-red-400"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>`;
                });
            }
        }

        function addSpendingRow() {
            const date = $('spendingDateLabel').innerText;
            if(date === '-') return alert('Pilih tanggal di kalender!');
            const n = prompt('Nama belanja:');
            const p = num(prompt('Harga (Angka saja):'));
            if(n && p) {
                if(!dbFinance[date]) dbFinance[date] = [];
                dbFinance[date].push({n, p});
                saveAll(); renderFinance(); selectFinDate(date);
            }
        }

        function delSpending(date, idx) {
            dbFinance[date].splice(idx, 1);
            saveAll(); renderFinance(); selectFinDate(date);
        }

        function updateSummaries() {
            let dIn = 0, dOut = 0, mNet = 0, mOut = 0;
            const tday = today();
            const curM = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}`;

            dbSvc.forEach(s => {
                if(s.tIn === tday) dIn += s.dp;
                if(s.tOut === tday) dIn += (s.total - s.dp);
                if(s.tIn.startsWith(curM)) mNet += s.total;
            });

            dbPPOB.forEach(p => {
                const untung = p.jual - p.modal + p.admin;
                if(p.date === tday) dIn += untung;
                if(p.date.startsWith(curM)) mNet += untung;
            });

            Object.keys(dbFinance).forEach(d => {
                const total = dbFinance[d].reduce((a, b) => a + b.p, 0);
                if(d === tday) dOut += total;
                if(d.startsWith(curM)) { mOut += total; mNet -= total; }
            });

            $('sumDayIn').innerText = fmt(dIn);
            $('sumDayOut').innerText = fmt(dOut);
            $('sumMonthNet').innerText = fmt(mNet);
            $('sumMonthOut').innerText = fmt(mOut);
        }

        // --- PPOB & SECOND ---
        $('ppobForm').onsubmit = e => {
            e.preventDefault();
            dbPPOB.push({
                date: today(),
                jenis: $('ppobJenis').value,
                target: $('ppobTarget').value,
                modal: num($('ppobModal').value),
                jual: num($('ppobJual').value),
                admin: num($('ppobAdmin').value)
            });
            saveAll(); alert('Berhasil!'); e.target.reset();
        };

        $('secondForm').onsubmit = e => {
            e.preventDefault();
            dbSecond.push({
                id: Date.now(),
                unit: $('secUnit').value,
                note: $('secNote').value,
                beli: num($('secBeli').value),
                part: num($('secPart').value),
                harga: num($('secHarga').value),
                terjual: num($('secTerjual').value)
            });
            saveAll(); renderSecondHand(); e.target.reset();
        };

        function renderSecondHand() {
            const list = $('secondList');
            list.innerHTML = '';
            dbSecond.forEach(h => {
                const profit = h.terjual > 0 ? (h.terjual - (h.beli + h.part)) : 0;
                list.innerHTML += `
                    <div class="glass-card p-5 rounded-3xl shadow-sm relative overflow-hidden">
                        ${h.terjual > 0 ? '<div class="absolute top-2 right-2 bg-emerald-500 text-white text-[8px] px-2 py-1 rounded-full font-bold">LAKU</div>' : ''}
                        <h4 class="font-black text-slate-800 uppercase">${h.unit}</h4>
                        <p class="text-[10px] text-slate-400 mb-3">${h.note}</p>
                        <div class="grid grid-cols-2 gap-2 text-[10px] mb-4">
                            <div class="bg-slate-50 p-2 rounded-xl"><p class="opacity-50">Modal</p><p class="font-bold">${fmt(h.beli + h.part)}</p></div>
                            <div class="bg-blue-50 p-2 rounded-xl"><p class="opacity-50">Harga</p><p class="font-bold text-blue-600">${fmt(h.harga)}</p></div>
                        </div>
                        ${h.terjual > 0 ? `<div class="bg-emerald-500 p-3 rounded-2xl text-white flex justify-between font-black text-[11px]"><span>UNTUNG</span><span>${fmt(profit)}</span></div>` : ''}
                    </div>`;
            });
        }

        // --- IMPORT FEATURE (FIXED FOR YOUR FILE) ---
        function handleImport(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const content = evt.target.result;
                    // Mencari data servis (NAOMI_V99_DB)
                    if(content.includes('NAOMI_V99_DB')) {
                        const rawSvc = content.match(/localStorage\.setItem\('NAOMI_V99_DB', JSON\.stringify\((.*?)\)\)/)[1];
                        const oldSvc = JSON.parse(rawSvc);
                        
                        // Konversi struktur data lama ke baru
                        const converted = oldSvc.map(o => ({
                            id: o.uid,
                            cust: o.name,
                            wa: o.wa,
                            unit: o.unit,
                            cond: o.cond,
                            tIn: o.tIn,
                            tOut: o.tOut || '',
                            type: o.jenis || 'Ditinggal',
                            garansi: o.garansi || '-',
                            parts: o.parts || [],
                            total: o.total,
                            dp: o.dp,
                            payMethod: o.dp > 0 ? 'DP' : 'Bayar Saat Ambil',
                            statusWork: o.status === 'Selesai' ? 'Selesai' : 'Belum Selesai',
                            statusTake: o.status === 'Selesai' ? 'Sudah Diambil' : 'Belum Diambil'
                        }));
                        
                        dbSvc = [...converted, ...dbSvc];
                        
                        // Mencari data belanja (NAOMI_SPENDING_DB)
                        if(content.includes('NAOMI_SPENDING_DB')) {
                            const rawFin = content.match(/localStorage\.setItem\('NAOMI_SPENDING_DB', JSON\.stringify\((.*?)\)\)/)[1];
                            const oldFin = JSON.parse(rawFin);
                            dbFinance = {...dbFinance, ...oldFin};
                        }

                        saveAll();
                        alert('IMPORT BERHASIL! ' + converted.length + ' data servis telah ditambahkan.');
                        location.reload();
                    } else {
                        alert('Data lama tidak ditemukan dalam file ini.');
                    }
                } catch(err) {
                    alert('Gagal membaca file: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // --- UTILS ---
        const formatPrice = el => { el.value = el.value.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, "."); };
        function changeMonth(dir) { currentMonth += dir; if(currentMonth>11){currentMonth=0;currentYear++} if(currentMonth<0){currentMonth=11;currentYear--} renderFinance(); }
        function sortSvc(d) { dbSvc.sort((a,b) => d === 'newest' ? new Date(b.tIn) - new Date(a.tIn) : new Date(a.tIn) - new Date(b.tIn)); renderSvcTable(); }
        
        function initChart() {
            const ctx = $('financeChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            const days = [];
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate()-i);
                days.push(d.toISOString().split('T')[0]);
            }
            const data = days.map(d => {
                let t = 0;
                dbSvc.filter(s => s.tIn === d).forEach(s => t += s.total);
                return t;
            });
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days.map(d => d.split('-')[2]),
                    datasets: [{ label: 'Omzet', data, borderColor: '#3b82f6', fill: true, backgroundColor: '#3b82f611', tension: 0.4 }]
                },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        setInterval(() => { $('clockDisplay').innerText = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'medium' }); }, 1000);
        $('svcDateIn').value = today();
        addSvcPart();
        renderSvcTable();
    </script>
</body>
</html>